Nghiên cứu tình huống: Loại bỏ phần mềm độc hại khỏi thiết bị Android

Phần này sử dụng các tính năng hệ thống tệp và công cụ lập trình hệ thống được thảo luận trong wikibook này để tìm và loại bỏ phần mềm độc hại không mong muốn khỏi máy tính bảng Android. 

**TUYÊN BỐ TỪ CHỐI.** ĐẢM BẢO MỌI THÔNG TIN QUAN TRỌNG TRÊN THIẾT BỊ CỦA BẠN ĐƯỢC SAO LƯU TRƯỚC KHI CỐ GẮNG SỬA ĐỔI MÁY TÍNH BẢNG CỦA BẠN. KHÔNG KHUYẾN KHÍCH VIỆC SỬA ĐỔI CÀI ĐẶT HỆ THỐNG VÀ TỆP HỆ THỐNG. VIỆC CỐ GẮNG SỬA ĐỔI THIẾT BỊ BẰNG HƯỚNG DẪN NGHIÊN CỨU TÌNH HUỐNG NÀY CÓ THỂ KHIẾN MÁY TÍNH BẢNG CỦA BẠN CHIA SẺ, MẤT HOẶC HỎNG DỮ LIỆU. HƠN NỮA, MÁY TÍNH BẢNG CỦA BẠN CÓ THỂ HOẠT ĐỘNG KHÔNG CHÍNH XÁC HOẶC NGỪNG HOẠT ĐỘNG HOÀN TOÀN. SỬ DỤNG NGHIÊN CỨU TÌNH HUỐNG NÀY VỚI RỦI RO CỦA RIÊNG BẠN. CÁC TÁC GIẢ KHÔNG CHỊU TRÁCH NHIỆM VÀ KHÔNG ĐƯA RA BẤT KỲ BẢO ĐẢM NÀO VỀ TÍNH CHÍNH XÁC HOẶC TÍNH HOÀN CHỈNH CỦA CÁC HƯỚNG DẪN NÀY BAO GỒM TRONG NGHIÊN CỨU TÌNH HUỐNG NÀY. CÁC TÁC GIẢ KHÔNG CHỊU TRÁCH NHIỆM VÀ KHÔNG ĐƯA RA BẤT KỲ BẢO ĐẢM NÀO VỀ BẤT KỲ PHẦN MỀM NÀO, BAO GỒM PHẦN MỀM BÊN THỨ BA BÊN NGOÀI ĐƯỢC MÔ TẢ HOẶC LIÊN KẾT TRONG HƯỚNG DẪN NÀY.

# Bối cảnh
Một máy tính bảng Android E97 được mua từ Amazon đã phát triển một số lỗi kỳ lạ. Đáng chú ý nhất là ứng dụng trình duyệt luôn mở một trang web tại gotoamazing.com thay vì trang chủ được đặt trong tùy chọn của ứng dụng (được gọi là 'chiếm quyền điều khiển' trình duyệt). Chúng ta có thể sử dụng kiến ​​thức từ wikibook này để hiểu cách hành vi không mong muốn này xảy ra và cũng loại bỏ các ứng dụng được cài đặt sẵn không mong muốn khỏi thiết bị không?

# Công cụ được sử dụng
Mặc dù có thể sử dụng các công cụ dành cho nhà phát triển Android được cài đặt trên máy từ xa được kết nối USB, nhưng hướng dẫn này chỉ sử dụng các công cụ hệ thống trên máy tính bảng. Các ứng dụng sau đã được cài đặt - 

* **Malwarebytes**: Một công cụ phần mềm độc hại và lỗ hổng miễn phí.
* **Trình giả lập thiết bị đầu cuối**: Một cửa sổ thiết bị đầu cuối đơn giản cung cấp cho chúng ta quyền truy cập shell trên máy tính bảng.
* **KingRoot**: Một công cụ sử dụng các khai thác đã biết trong kernel linux để có quyền truy cập root.

Việc cài đặt bất kỳ ứng dụng nào có khả năng cho phép thực thi mã tùy ý nếu nó có thể phá vỡ mô hình bảo mật của Android. Trong số các ứng dụng được đề cập ở trên, KingRoot là ví dụ cực đoan nhất vì nó khai thác các lỗ hổng hệ thống để có quyền truy cập root cho mục đích của chúng ta. Tuy nhiên, khi làm như vậy, nó cũng có thể
Trong số này, KingRoot là công cụ đáng ngờ nhất để cài đặt - chúng tôi tin tưởng rằng nó sẽ không cài đặt bất kỳ phần mềm độc hại nào của riêng nó. Một giải pháp thay thế an toàn hơn tiềm năng là sử dụng https://github.com/android-rooting-tools/

# Tổng quan về thiết bị đầu cuối

Các lệnh hữu ích nhất là  `su`, `grep`, `mount` và công cụ quản lý gói của Android là `pm`.

* `grep -s abc * */*`   (tìm kiếm `abc` trong thư mục hiện tại và các thư mục con trực tiếp)
* `su` (hay còn gọi là "chuyển đổi người dùng" trở thành root - yêu cầu thiết bị đã được root)
* `mount -o rw,remount /system`  (cho phép phân vùng `/system` có thể ghi)
* `pm disable`  (hay còn gọi là 'trình quản lý gói', vô hiệu hóa gói ứng dụng Android)

# Tổng quan về bố cục hệ thống tệp

Trên máy tính bảng cụ thể này chạy Android 4.4.2, các ứng dụng được cài đặt sẵn là không thể sửa đổi và nằm trong:
```
/system/app/
/system/priv-app/
```
và tùy chọn và dữ liệu ứng dụng được lưu trữ trong phân vùng `/data`.
Mỗi ứng dụng thường được đóng gói bên trong một tệp APK, về cơ bản là một tệp ZIP. Khi một ứng dụng được cài đặt, mã được giải nén thành một tệp có thể được máy ảo Android phân tích cú pháp trực tiếp. Mã nhị phân (ít nhất là cho máy ảo cụ thể này) có phần mở rộng ODEX.

Chúng ta có thể tìm kiếm mã của các ứng dụng hệ thống đã cài đặt cho chuỗi 'gotoamazing':
```bash
grep -s gotoamazing /system/app/* /system/priv-app/*
```
Điều này không tìm thấy bất cứ điều gì; có vẻ như chuỗi này không được mã hóa cứng vào mã nguồn của các ứng dụng hệ thống nhất định. 

Hãy kiểm tra khu vực dữ liệu của tất cả các ứng dụng đã cài đặt:
```bash
cd /data/data
grep -s gotoamazing * */* */*/*
```
Kết quả thu được:
```
data/com.android.browser/shared_prefs/xbservice.xml: <string name="URL">http://www.gotoamazing...
```
Tùy chọn `-s` "tùy chọn im lặng" ngăn `grep` phàn nàn về việc cố gắng grep các thư mục và các tệp không hợp lệ khác. Lưu ý rằng chúng ta cũng có thể đã sử dụng `-r` để tìm kiếm đệ quy các thư mục, nhưng thật thú vị khi sử dụng globbing tệp (mở rộng ký tự đại diện `*` của shell).

Bây giờ chúng ta đang đi đến đâu đó! Có vẻ như chuỗi này là một phần của ứng dụng 'com.android.browser' nhưng hãy cùng tìm hiểu xem mã nhị phân ứng dụng nào mở tùy chọn 'xbservice'. Có lẽ dịch vụ không mong muốn này đang ẩn bên trong một ứng dụng khác và cố gắng tải bí mật như một phần mở rộng cho trình duyệt?

Hãy tìm kiếm bất kỳ tệp nào chứa `xbservice`. Lần này, chúng tôi sẽ tìm kiếm đệ quy trong các thư mục của `/system` bao gồm 'app':

```bash
grep -r -s xbservice /system/*app*
Tệp nhị phân /system/app/Browser.odex khớp
```
Cuối cùng - có vẻ như trình duyệt gốc đã được xuất xưởng với việc chiếm quyền điều khiển trang chủ được cài đặt sẵn. Hãy gỡ cài đặt nó. Đối với điều này, hãy trở thành root.

```bash
$ su
# pm list packages -s
```

Trình quản lý gói của Android có nhiều lệnh và tùy chọn. Ví dụ trên liệt kê tất cả các ứng dụng hệ thống hiện đang được cài đặt. Chúng ta có thể gỡ cài đặt ứng dụng trình duyệt bằng cách sử dụng các lệnh sau:

```bash
pm disable com.android.browser
pm uninstall com.android.browser
```

Sử dụng `pm list packages`, bạn có thể liệt kê tất cả các gói đã cài đặt (sử dụng tùy chọn `-s` để chỉ xem các gói hệ thống). Chúng tôi đã vô hiệu hóa các ứng dụng hệ thống sau. Tất nhiên, không có gì đảm bảo thực sự rằng chúng tôi đã xóa thành công tất cả phần mềm không mong muốn hoặc một trong số này là dương tính giả. Do đó, chúng tôi không khuyến nghị giữ thông tin nhạy cảm trên máy tính bảng như vậy.


* `com.android.browser`
* `com.adups.fota.sysoper`
* `elink.com`
* `com.google.android.apps.cloudprint`
* `com.mediatek.CrashService`
* `com.get.googleApps`
* `com.adups.fota` (gói over-the-air có thể cài đặt các mục tùy ý trong tương lai).
* `com.mediatek.appguide.plugin`

Có khả năng là bạn có thể kích hoạt lại gói bằng cách sử dụng `pm enable <tên_gói>` hoặc `pm install` và tệp `.apk` có liên quan trong `/system/app` hoặc `/system/priv-app`.






